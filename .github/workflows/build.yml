name: æ„å»ºå’Œå‘å¸ƒQtå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]      # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    tags:
      - 'v*'                # æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  pull_request:
    branches: [ main ]      # åˆ›å»ºPRåˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:        # å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  # Windowsæ„å»ºä»»åŠ¡
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: windows-latest
    
    # è®¾ç½®æƒé™ï¼šå…è®¸åˆ›å»ºå’Œæ›´æ–°Releases
    permissions:
      contents: write        # å…è®¸åˆ›å»ºReleaseå’Œä¸Šä¼ æ–‡ä»¶
      
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'  # è‡ªåŠ¨åˆå§‹åŒ–å’Œæ›´æ–°å­æ¨¡å—
      
    # æ­¥éª¤2: è®¾ç½®MSVCç¼–è¯‘ç¯å¢ƒ
    - name: ğŸ”§ è®¾ç½®MSVC
      uses: microsoft/setup-msbuild@v2
      
    # æ­¥éª¤3: å®‰è£…Qtå¼€å‘ç¯å¢ƒ
    - name: ğŸ”§ å®‰è£…Qt 6.6.3
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.6.3'           # Qtç‰ˆæœ¬ï¼ˆElaWidgetToolsæ¨è6.6.3ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§ï¼‰
        host: 'windows'            # ä¸»æœºå¹³å°
        target: 'desktop'          # ç›®æ ‡å¹³å°
        arch: 'win64_msvc2019_64'  # æ¶æ„ï¼šMSVC 2019 64ä½
        cache: true                # å¯ç”¨ç¼“å­˜ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦
        
    # æ­¥éª¤4: é…ç½®CMakeé¡¹ç›®
    - name: âš™ï¸ é…ç½®CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        
    # æ­¥éª¤5: ç¼–è¯‘é¡¹ç›®
    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: |
        cd build
        cmake --build . --config Release
        
    # æ­¥éª¤6: ä½¿ç”¨windeployqtéƒ¨ç½²Qtä¾èµ–
    - name: ğŸ“¦ éƒ¨ç½²Qtä¾èµ–
      run: |
        cd build\Release
        windeployqt StudentSystem.exe
        
        # å¤åˆ¶ ElaWidgetTools åº“æ–‡ä»¶
        echo "æ­£åœ¨å¤åˆ¶ ElaWidgetTools åº“æ–‡ä»¶..."
        if (Test-Path "..\ElaWidgetTools\ElaWidgetTools\ElaWidgetTools.dll") {
          Copy-Item -Path "..\ElaWidgetTools\ElaWidgetTools\ElaWidgetTools.dll" -Destination "." -Force
          Write-Host "âœ… ElaWidgetTools.dll å¤åˆ¶æˆåŠŸ"
        } else {
          Write-Host "âš ï¸ è­¦å‘Š: ElaWidgetTools.dll æœªæ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–è·¯å¾„..."
          if (Test-Path "..\ElaWidgetTools\ElaWidgetTools\Release\ElaWidgetTools.dll") {
            Copy-Item -Path "..\ElaWidgetTools\ElaWidgetTools\Release\ElaWidgetTools.dll" -Destination "." -Force
            Write-Host "âœ… ElaWidgetTools.dll ä»Releaseç›®å½•å¤åˆ¶æˆåŠŸ"
          }
        }
        
    # æ­¥éª¤7: åˆ›å»ºå‘å¸ƒåŒ…
    - name: ğŸ“‚ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir StudentSystem-Windows
        
        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item -Path "build\Release\StudentSystem.exe" -Destination "StudentSystem-Windows\"
        
        # å¤åˆ¶æ‰€æœ‰DLLæ–‡ä»¶
        Copy-Item -Path "build\Release\*.dll" -Destination "StudentSystem-Windows\" -ErrorAction SilentlyContinue
        
        # å¤åˆ¶Qtæ’ä»¶ç›®å½•
        Copy-Item -Path "build\Release\platforms" -Destination "StudentSystem-Windows\platforms" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\styles" -Destination "StudentSystem-Windows\styles" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\imageformats" -Destination "StudentSystem-Windows\imageformats" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\iconengines" -Destination "StudentSystem-Windows\iconengines" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\generic" -Destination "StudentSystem-Windows\generic" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\networkinformation" -Destination "StudentSystem-Windows\networkinformation" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\tls" -Destination "StudentSystem-Windows\tls" -Recurse -ErrorAction SilentlyContinue
        
        # å¤åˆ¶ç¿»è¯‘æ–‡ä»¶
        Copy-Item -Path "build\Release\translations" -Destination "StudentSystem-Windows\translations" -Recurse -ErrorAction SilentlyContinue
        
        # å¤åˆ¶è¯´æ˜æ–‡æ¡£ï¼ˆä»…README.mdï¼‰
        Copy-Item -Path "README.md" -Destination "StudentSystem-Windows\"
        
        # å‹ç¼©æˆZIPæ–‡ä»¶
        Compress-Archive -Path "StudentSystem-Windows\*" -DestinationPath "StudentSystem-Windows.zip"
        
    # æ­¥éª¤8: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Actions
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: StudentSystem-Windows
        path: StudentSystem-Windows.zip
        retention-days: 30          # ä¿ç•™30å¤©
        
    # æ­¥éª¤9: è·å–æœ€æ–°ç‰ˆæœ¬å·å¹¶è‡ªåŠ¨é€’å¢
    - name: ğŸ”¢ è‡ªåŠ¨è®¡ç®—æ–°ç‰ˆæœ¬å·
      if: github.ref == 'refs/heads/main'
      id: version
      run: |
        # è·å–æœ€æ–°çš„releaseç‰ˆæœ¬å·
        $latestRelease = gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>$null
        
        if ($latestRelease) {
          Write-Host "ğŸ“Œ å½“å‰æœ€æ–°ç‰ˆæœ¬: $latestRelease"
          # æå–ç‰ˆæœ¬å·ï¼ˆå‡è®¾æ ¼å¼ä¸º v1.0ï¼‰
          if ($latestRelease -match 'v(\d+)\.(\d+)') {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            # é€’å¢ä¸»ç‰ˆæœ¬å·
            $newMajor = $major + 1
            $newVersion = "v$newMajor.0"
          } else {
            $newVersion = "v1.0"
          }
        } else {
          Write-Host "ğŸ“Œ è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬"
          $newVersion = "v1.0"
        }
        
        Write-Host "ğŸ¯ æ–°ç‰ˆæœ¬å·: $newVersion"
        echo "new_version=$newVersion" >> $env:GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # æ­¥éª¤10: è‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€ç‰ˆæœ¬æ ‡ç­¾
    - name: ğŸ·ï¸ åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
      if: github.ref == 'refs/heads/main'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a ${{ steps.version.outputs.new_version }} -m "Auto-release ${{ steps.version.outputs.new_version }}"
        git push origin ${{ steps.version.outputs.new_version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # æ­¥éª¤11: åˆ›å»ºæ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼ˆæ¯æ¬¡æ„å»ºæˆåŠŸåè‡ªåŠ¨å‘å¸ƒï¼‰
    - name: ğŸ‰ å‘å¸ƒæ­£å¼ç‰ˆæœ¬
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        name: å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ ${{ steps.version.outputs.new_version }}
        tag_name: ${{ steps.version.outputs.new_version }}
        files: StudentSystem-Windows.zip
        draft: false               # ä¸åˆ›å»ºè‰ç¨¿
        prerelease: false          # æ­£å¼ç‰ˆæœ¬
        generate_release_notes: true # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
        body: |
          ## ğŸ‰ å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ ${{ steps.version.outputs.new_version }} - Fluent-UI ç°ä»£åŒ–ç•Œé¢
          
          âœ¨ **å…¨æ–°ç•Œé¢**ï¼šé‡‡ç”¨ Microsoft Fluent Design è®¾è®¡è¯­è¨€ï¼
          
          æœ¬ç‰ˆæœ¬å·²é€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºæµ‹è¯•ï¼Œå¯æ”¾å¿ƒä½¿ç”¨ã€‚
          
          **âœ¨ ä¸»è¦ç‰¹æ€§**ï¼š
          - ğŸ¨ ç°ä»£åŒ– Fluent-UI é£æ ¼ç•Œé¢
          - ğŸŒ«ï¸ Acrylic äºšå…‹åŠ›ç»ç’ƒæ•ˆæœï¼ˆWindows 11ï¼‰
          - ğŸ“¦ ç²¾ç¾ 3D å¡ç‰‡è®¾è®¡
          - ğŸ“Š å­¦ç”Ÿä¿¡æ¯å¢åˆ æ”¹æŸ¥åŠŸèƒ½
          - ğŸ” æ™ºèƒ½æœç´¢å’Œæ’åº
          - âœ¨ æµç•…çš„åŠ¨ç”»æ•ˆæœ
          - ğŸ’¬ å‹å¥½çš„ç”¨æˆ·æç¤º
          - ğŸ­ æ”¯æŒä¸»é¢˜åˆ‡æ¢
          
          **æ„å»ºä¿¡æ¯**ï¼š
          - ğŸ“¦ ç‰ˆæœ¬å·ï¼š${{ steps.version.outputs.new_version }}
          - ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
          - ğŸ”¨ æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}
          - ğŸ‘¤ æäº¤è€…ï¼š${{ github.event.head_commit.author.name }}
          - ğŸ”— æäº¤SHAï¼š${{ github.sha }}
          - ğŸ¨ UIæ¡†æ¶ï¼šElaWidgetTools (Fluent-UI)
          - ğŸ› ï¸ Qtç‰ˆæœ¬ï¼š6.6.3
          
          **ä¸‹è½½è¯´æ˜**ï¼š
          1. ä¸‹è½½ä¸‹æ–¹çš„ `StudentSystem-Windows.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `StudentSystem.exe` è¿è¡Œ
          
          **ç³»ç»Ÿè¦æ±‚**ï¼š
          - Windows 10/11 (64ä½)
          - æ¨è Windows 11 ä»¥è·å¾—å®Œæ•´äºšå…‹åŠ›æ•ˆæœ
          - æ— éœ€å®‰è£…Qtç¯å¢ƒ
          - æ— éœ€é¢å¤–ä¾èµ–
          
          **æŠ€æœ¯æ ˆ**ï¼š
          - Qt 6.6.3
          - ElaWidgetTools (Fluent-UI)
          - C++17
          
          ---
          
          ğŸ“– [å®Œæ•´æ–‡æ¡£](https://github.com/SenyFish/StudentSystem)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

