name: æ„å»ºå’Œå‘å¸ƒQtå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]      # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    tags:
      - 'v*'                # æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  pull_request:
    branches: [ main ]      # åˆ›å»ºPRåˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:        # å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  # Windowsæ„å»ºä»»åŠ¡
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: windows-latest
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    # æ­¥éª¤2: è®¾ç½®MSVCç¼–è¯‘ç¯å¢ƒ
    - name: ğŸ”§ è®¾ç½®MSVC
      uses: microsoft/setup-msbuild@v2
      
    # æ­¥éª¤3: å®‰è£…Qtå¼€å‘ç¯å¢ƒ
    - name: ğŸ”§ å®‰è£…Qt 6.9.0
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.0'           # Qtç‰ˆæœ¬
        host: 'windows'            # ä¸»æœºå¹³å°
        target: 'desktop'          # ç›®æ ‡å¹³å°
        arch: 'win64_msvc2019_64'  # æ¶æ„ï¼šMSVC 2019 64ä½
        cache: true                # å¯ç”¨ç¼“å­˜ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦
        
    # æ­¥éª¤4: é…ç½®CMakeé¡¹ç›®
    - name: âš™ï¸ é…ç½®CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        
    # æ­¥éª¤5: ç¼–è¯‘é¡¹ç›®
    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: |
        cd build
        cmake --build . --config Release
        
    # æ­¥éª¤6: ä½¿ç”¨windeployqtéƒ¨ç½²Qtä¾èµ–
    - name: ğŸ“¦ éƒ¨ç½²Qtä¾èµ–
      run: |
        cd build\Release
        windeployqt StudentSystem.exe
        
    # æ­¥éª¤7: åˆ›å»ºå‘å¸ƒåŒ…
    - name: ğŸ“‚ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir StudentSystem-Windows
        
        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item -Path "build\Release\StudentSystem.exe" -Destination "StudentSystem-Windows\"
        
        # å¤åˆ¶æ‰€æœ‰DLLæ–‡ä»¶
        Copy-Item -Path "build\Release\*.dll" -Destination "StudentSystem-Windows\" -ErrorAction SilentlyContinue
        
        # å¤åˆ¶Qtæ’ä»¶ç›®å½•
        Copy-Item -Path "build\Release\platforms" -Destination "StudentSystem-Windows\platforms" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\styles" -Destination "StudentSystem-Windows\styles" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\imageformats" -Destination "StudentSystem-Windows\imageformats" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\iconengines" -Destination "StudentSystem-Windows\iconengines" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\generic" -Destination "StudentSystem-Windows\generic" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\networkinformation" -Destination "StudentSystem-Windows\networkinformation" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\tls" -Destination "StudentSystem-Windows\tls" -Recurse -ErrorAction SilentlyContinue
        
        # å¤åˆ¶ç¿»è¯‘æ–‡ä»¶
        Copy-Item -Path "build\Release\translations" -Destination "StudentSystem-Windows\translations" -Recurse -ErrorAction SilentlyContinue
        
        # å¤åˆ¶è¯´æ˜æ–‡æ¡£
        Copy-Item -Path "README.md" -Destination "StudentSystem-Windows\"
        Copy-Item -Path "DEPLOYMENT.md" -Destination "StudentSystem-Windows\" -ErrorAction SilentlyContinue
        
        # å‹ç¼©æˆZIPæ–‡ä»¶
        Compress-Archive -Path "StudentSystem-Windows\*" -DestinationPath "StudentSystem-Windows.zip"
        
    # æ­¥éª¤8: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Actions
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: StudentSystem-Windows
        path: StudentSystem-Windows.zip
        retention-days: 30          # ä¿ç•™30å¤©
        
    # æ­¥éª¤9: åˆ›å»ºGitHub Releaseï¼ˆä»…åœ¨æ¨é€tagæ—¶æ‰§è¡Œï¼‰
    - name: ğŸš€ åˆ›å»ºGitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: StudentSystem-Windows.zip
        draft: false                # ä¸åˆ›å»ºè‰ç¨¿
        prerelease: false           # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        generate_release_notes: true # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

