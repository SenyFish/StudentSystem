name: æ„å»ºå’Œå‘å¸ƒQtå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]      # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    tags:
      - 'v*'                # æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  pull_request:
    branches: [ main ]      # åˆ›å»ºPRåˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:        # å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  # Windowsæ„å»ºä»»åŠ¡
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: windows-latest
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    # æ­¥éª¤2: è®¾ç½®MSVCç¼–è¯‘ç¯å¢ƒ
    - name: ğŸ”§ è®¾ç½®MSVC
      uses: microsoft/setup-msbuild@v2
      
    # æ­¥éª¤3: å®‰è£…Qtå¼€å‘ç¯å¢ƒ
    - name: ğŸ”§ å®‰è£…Qt 6.7.3
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.3'           # Qtç‰ˆæœ¬ï¼ˆ6.9.0æš‚ä¸æ”¯æŒMSVCï¼Œä½¿ç”¨ç¨³å®šç‰ˆ6.7.3ï¼‰
        host: 'windows'            # ä¸»æœºå¹³å°
        target: 'desktop'          # ç›®æ ‡å¹³å°
        arch: 'win64_msvc2019_64'  # æ¶æ„ï¼šMSVC 2019 64ä½
        cache: true                # å¯ç”¨ç¼“å­˜ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦
        
    # æ­¥éª¤4: é…ç½®CMakeé¡¹ç›®
    - name: âš™ï¸ é…ç½®CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        
    # æ­¥éª¤5: ç¼–è¯‘é¡¹ç›®
    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: |
        cd build
        cmake --build . --config Release
        
    # æ­¥éª¤6: ä½¿ç”¨windeployqtéƒ¨ç½²Qtä¾èµ–
    - name: ğŸ“¦ éƒ¨ç½²Qtä¾èµ–
      run: |
        cd build\Release
        windeployqt StudentSystem.exe
        
    # æ­¥éª¤7: åˆ›å»ºå‘å¸ƒåŒ…
    - name: ğŸ“‚ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir StudentSystem-Windows
        
        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item -Path "build\Release\StudentSystem.exe" -Destination "StudentSystem-Windows\"
        
        # å¤åˆ¶æ‰€æœ‰DLLæ–‡ä»¶
        Copy-Item -Path "build\Release\*.dll" -Destination "StudentSystem-Windows\" -ErrorAction SilentlyContinue
        
        # å¤åˆ¶Qtæ’ä»¶ç›®å½•
        Copy-Item -Path "build\Release\platforms" -Destination "StudentSystem-Windows\platforms" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\styles" -Destination "StudentSystem-Windows\styles" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\imageformats" -Destination "StudentSystem-Windows\imageformats" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\iconengines" -Destination "StudentSystem-Windows\iconengines" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\generic" -Destination "StudentSystem-Windows\generic" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\networkinformation" -Destination "StudentSystem-Windows\networkinformation" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "build\Release\tls" -Destination "StudentSystem-Windows\tls" -Recurse -ErrorAction SilentlyContinue
        
        # å¤åˆ¶ç¿»è¯‘æ–‡ä»¶
        Copy-Item -Path "build\Release\translations" -Destination "StudentSystem-Windows\translations" -Recurse -ErrorAction SilentlyContinue
        
        # å¤åˆ¶è¯´æ˜æ–‡æ¡£
        Copy-Item -Path "README.md" -Destination "StudentSystem-Windows\"
        Copy-Item -Path "DEPLOYMENT.md" -Destination "StudentSystem-Windows\" -ErrorAction SilentlyContinue
        
        # å‹ç¼©æˆZIPæ–‡ä»¶
        Compress-Archive -Path "StudentSystem-Windows\*" -DestinationPath "StudentSystem-Windows.zip"
        
    # æ­¥éª¤8: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Actions
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: StudentSystem-Windows
        path: StudentSystem-Windows.zip
        retention-days: 30          # ä¿ç•™30å¤©
        
    # æ­¥éª¤9: è‡ªåŠ¨å‘å¸ƒæœ€æ–°ç‰ˆæœ¬ï¼ˆæ¯æ¬¡æ¨é€mainåˆ†æ”¯æ—¶ï¼‰
    - name: ğŸš€ å‘å¸ƒæœ€æ–°å¼€å‘ç‰ˆæœ¬
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        name: æœ€æ–°å¼€å‘ç‰ˆ (è‡ªåŠ¨æ„å»º)
        tag_name: latest           # ä½¿ç”¨"latest"æ ‡ç­¾
        files: StudentSystem-Windows.zip
        draft: false               # ä¸åˆ›å»ºè‰ç¨¿
        prerelease: true           # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          è¿™æ˜¯æœ€æ–°çš„è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œæ¯æ¬¡ä»£ç æ›´æ–°éƒ½ä¼šè‡ªåŠ¨å‘å¸ƒã€‚
          
          **æ„å»ºä¿¡æ¯**ï¼š
          - ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
          - ğŸ”¨ æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}
          - ğŸ‘¤ æäº¤è€…ï¼š${{ github.event.head_commit.author.name }}
          - ğŸ”— æäº¤SHAï¼š${{ github.sha }}
          
          **ä¸‹è½½è¯´æ˜**ï¼š
          1. ä¸‹è½½ `StudentSystem-Windows.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `StudentSystem.exe` è¿è¡Œ
          
          **æ³¨æ„**ï¼šè¿™æ˜¯å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„æ–°åŠŸèƒ½ã€‚
          å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·ä¸‹è½½æ­£å¼å‘å¸ƒçš„ç‰ˆæœ¬ï¼ˆv1.0.0ç­‰ï¼‰ã€‚
          
          ---
          
          ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/SenyFish/StudentSystem/blob/main/README.md) | 
          â“ [å¸¸è§é—®é¢˜](https://github.com/SenyFish/StudentSystem/blob/main/DOWNLOAD.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # æ­¥éª¤10: åˆ›å»ºæ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼ˆä»…åœ¨æ¨é€tagæ—¶æ‰§è¡Œï¼‰
    - name: ğŸ‰ å‘å¸ƒæ­£å¼ç‰ˆæœ¬
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: StudentSystem-Windows.zip
        draft: false                # ä¸åˆ›å»ºè‰ç¨¿
        prerelease: false           # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        generate_release_notes: true # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
        body: |
          ## ğŸ‰ æ­£å¼å‘å¸ƒç‰ˆæœ¬
          
          è¿™æ˜¯ç»è¿‡æµ‹è¯•çš„ç¨³å®šç‰ˆæœ¬ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
          
          **ä¸‹è½½è¯´æ˜**ï¼š
          1. ä¸‹è½½ä¸‹æ–¹çš„ `StudentSystem-Windows.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `StudentSystem.exe` è¿è¡Œ
          
          **ç³»ç»Ÿè¦æ±‚**ï¼š
          - Windows 10/11 (64ä½)
          - æ— éœ€å®‰è£…Qtç¯å¢ƒ
          
          ---
          
          ğŸ“– [å®Œæ•´æ–‡æ¡£](https://github.com/SenyFish/StudentSystem) | 
          ğŸ“ [æ›´æ–°æ—¥å¿—](https://github.com/SenyFish/StudentSystem/blob/main/CHANGELOG.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

